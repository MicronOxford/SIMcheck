<!DOCTYPE html>                                                                 
<html lang="en">                                                                

    <head>                                                                      
        <meta charset="utf-8">                                                  
        <title>SIMcheck</title>                                              
    </head>                                                                     

    <body>                                                                      

        <!-- Title, Introduction and TOC -->
        <center><h1>SIMcheck (v0.9)</h1></center>
    
        <p>SIMcheck is a package of tools for assessing the quality and 
        reliability of Structured Illumination Microscopy (SIM) data. Although
        originally developed for API OMX data, SIMcheck may be used with data 
        from other systems including Zeiss's ELYRA and Nikon's N-SIM. It is 
        implemented as an ImageJ plugin bundle consisting of the main 
        "SIMcheck" Dialog, which assembles the required inputs and run multiple 
        checks; and the individual checks which may also be run as stand-alone 
        plugins. This help page is organized into several sections: SI theory, 
        SI Microscopy systems and data formats, instructions for running 
        SIMcheck, and finally, the 3 classes of SIMcheck plugins.</p> 

        <h3>Quick Start</h3>
            See sections <a href=#RunSIMcheck>3 (Running SIMcheck)</a>, 
            <a href=#PreProc>5 (raw data)</a>,
            and <a href=#PostRecon>6 (reconstructed data)</a>. Currently
            it is best to analyze different channels and time-points 
            separately.
        <hr>

        <ol><li><b><a href=#SIMtheory>SIM Theory</a></b></li>
            <li><b><a href=#SIMsys>SI Microscopy Systems</a></b></li>
                <ol><li><a href=#OMX>API OMX</a></li>
                    <li><a href=#ELYRA>Zeiss ELYRA</a></li>
                    <li><a href=#NSIM>Nikon N-SIM</a></li>
                </ol>
            <li><b><a href=#RunSIMcheck>Running SIMcheck</a></b></li>
            <li><b><a href=#Calibration>Microscope Calibration Checks</a></b>
                <ol><li><a href=#CalibIllum>Calibrate Illumination</a></li>
                    <!--
                    <li><a href=#CalibPSF>Calibrate PSF</a></li>
                    <li><a href=#CalibParams>Calibrate Reconstruction Parameters</a></li>
                    <li><a href=#CalibGrating>Calibrate Grating</a></li>
                    -->
                </ol>
            </li>
            <li><b><a href=#PreProc>Raw Data Checks</a></b>
                <ol><li><a href=#SIZprof>Raw data Intensity profile</a></li>
                    <li><a href=#SIfourier>Raw data Fourier plots</a></li>
                    <li><a href=#SIfloaties>Raw data Motion Check</a></li>
                    <li><a href=#SIMCNR>Raw data Modulation Contrast</a></li>
                </ol>
            </li>
            <li><b><a href=#PostRecon>Reconstructed Data Checks</a></b>
                <ol><li><a href=#SIRhist>SIR Histogram</a></li>
                    <li><a href=#SIRzvar>SIR Z variaton</a></li>
                    <li><a href=#SIRfourier>SIR Fourier plot</a></li>
                    <li><a href=#SIRquality>SIR Mod Contrast map</a></li>
                </ol>
            </li>
            <li><b><a href=#SIUtils>SI Utilities</a></b>
                <ol><li><a href=#SItoWF>SI to wide-field</a></li>
                    <li><a href=#SIformats>SI format converter</a></li>
                </ol>
            </li>
            <li><b><a href="http://microna.bioch.ox.ac.uk/~graemeb/api/index.html">API Docs</a></b></li>
        </ol>
        <hr>


        <!-- SI theory section -->
        <h2><a id="SIMtheory">SIM Theory</a></h2>
        <h4>references</h4>
        <ul><li><i>Surpassing the lateral resolution limit ...; M. G. L. 
                Gustafsson (2000), J. Micros. <b>198</b>, 82-.</i></li>
            <li><i>Three-Dimensional Resolution Doubling ...; Mats G. L. 
                Gustafsson et al. (2008), Biophys. J. <b>94</b>, 4957-.</i></li>
        </ul>
        <p>Structured illumination is ...</p>
        <hr>

        
        <!-- Section describing the SI microscopy systems -->
        <h2><a id="SIMsys">SI Microscopy Systems</a></h2>

            <h3><a id="OMX">API OMX</a></h3>
                <p>The API OMX systems, based on a prototypes built in the lab
                   of John Sedat at UCSF, all share a common data acquisition
                   scheme and file format. OMX microscopes use the MRC file 
                   format which was adapted for the DeltaVision family of
                   wide-field deconvolution microscopes (also originating
                   at UCSF in the Sedat and Agard labs), as described in the 
                   <a href="http://www.msg.ucsf.edu/IVE/index.html">online 
                   documentation</a> of their Priism image processing package 
                   (which, incidentally, forms the basis for API's SoftWoRx,
                   and is still being developed).</p>
                <p>Data are acquired in several different schemes by the
                   different versions of OMX microscope, but all are stored 
                   in a "CPZAT" dimension order: i.e. channel, then phase, 
                   then Z-plane, then angle, then time frame. When opening 
                   such data in ImageJ, one usually sees all phases and
                   angles subsumed into the Z dimension, meaning 
                   Zobserved=P*Zreal*A, with phase varying fasest, then real Z,
                   and finally the angle.
                   Note that bleaching dependent on the true order of data 
                   acquisition may well be apparent when using the  
                   "SI Z-profile" check described below. OMX miscroscopes 
                   invariably acquire 3 angles and 5 phases of the illumination 
                   pattern.</p>

            <h3><a id="ELYRA">Zeiss ELYRA</a></h3>
                <p>The Zeiss ELYRA system has greater flexibility in terms of
                   the number of different angles acquired, with both 
                   3 angles and 5 angles typically used (the latter produces
                   higher quality reconstructions given a sufficiently 
                   photostable sample). The number of phases is limited to 5
                   as for the API OMX systems.</p>
                <p>ELYRA data are typically stored in .czi format files,
                   with different angles and phases stored as separate series
                   within a single file. Note that the LOCI Bio-Formats 
                   importer (which Fiji ImageJ uses by default) is able to
                   concatenate the separate series upon import if the   
                   <b>"Concatenate series when compatible"</b> box is ticked 
                   (in the "Dataset organization" section of the Import Options
                   Dialog), which is recommended for use with SIMcheck. See the
                   figure below.</p> 
                   <!-- TODO: insert a (numbered?) figure showing import? -->
                   <p>In this case, the resulting hyperstack will have the 
                   phases and angles subsumed into the time dimension, with the
                   real time varying fastest, then angle, then finally phase:
                   i.e. T_observed = T_real*angle*phase. SIMcheck re-orders the
                   data into the OMX "CPZAT" order prior to running the 
                   pre-processing checks for convenience.</p>
                   
            <h3><a id="NSIM">Nikon N-SIM</a></h3>
                <p>Nikon N-SIM raw data are stored as tiled images in .nd2
                   files; where phases are tiled in the x-direction, angles in
                   the y-direction. The format converter is untested for 3D
                   data.
                </p>
        <hr>


        <!-- Section describing how to use SIMcheck -->
        <h2><a id="RunSIMcheck">Running SIMcheck</a></h2>
            <h3>Basic use</h3>
            <ol>
                <li>The package installs a SIMcheck menu into ImageJ's 
                    <b>Plugins</b> menu. Within this menu, the "SIMcheck" 
                    option opens a dialog for running some or all of the 
                    checks.</li>
                <li>Before running SIMcheck, import the data as a single stack 
                    - SIMcheck can be used to convert ELYRA and NSIM data to 
                    the API OMX dimenson ordering (main SIMcheck plugin or 
                    SIMcheck-&gt;Utilities-&gt;SIM format converter). 
                    See the <a href="#ELYRA">ELYRA</a> and 
                    <a href="#NSIM">ELYRA</a> sections for descriptions of the
                    differences.
                <li>Consider cropping before running the checks, to save time
                    and avoid running out of memory (NB. memory allocated to
                    ImageJ can be adjusted in Edit-Options-Memory &amp; threads).</li>
                <li>Now specify image stacks to use, checks to run, and 
                    provide/check the additional parameters (i.e. Phases and
                    Angles) before clicking the OK button to start running the
                    checks.</li>
            </ol>
            <h3>Additional information</h3>
            <ul>
                <li>In addtion to the main SIMcheck plugin, the individual
                    checks can be run as standalone plugins, and are 
                    organized into categories in the same way as this page.
                <li>All raw SI data formats must be re-ordered into the 
                    OMX "CPZAT" order prior to running pre-processing 
                    checks - the main SIMcheck dialog does this, but the
                    "SI converter" plugin in the utilities menu can also be 
                    used.</li>
                <li>Make sure your reconstruction shows negative values - do
                    not discard them (if you must) until later.</li>
                <li>The "SIR Mod Contrast Map" requires both raw SI and SIR 
                    reconstructed images to be selected - alternatively, 
                    when run standalone you can specify a previously-
                    calculated MCNR image</li>
            </ul>
        <hr>


        <!-- Section describing the calibration checks -->
        <h2><a id="Calibration">Microscope Calibration Checks</a></h2>
            <h3><a id="CalibIllum">Calibrate Structured Illumination</a></h3>
              <ul>
                  <li><b>What?</b> check system stability and alignment by 
                  detecting illumination pattern frequencies and plotting 
                  phase steps.</li>
                  <li><b>Why?</b> SI illumination pattern must be in-focus, 
                  modulated with the proper frequencies, and accurate, 
                  stable phase steps.</li>
              </ul>
              <!--  TODO
            <h3><a id="CalibPSF">Calibrate SI PSF (TODO)</a></h3>
              <ul>
                <li><b>What?</b> SI PSF quality metrics</li>
                <li><b>Why?</b> to assist in optimizing the oil to achieve the
                best imaging possible, and/or diagnose alignment problems 
                in the system.</li>
              </ul>
            <h3><a id="CalibParams">Calibrate Reconstruction Parameters (TODO)</a></h3>
              <ul>
                <li><b>What?</b> k0 values, where k0 are vectors for the
                  illumination pattern for each angle; and line-spacings, 
                  which are the distances between pattern maxima for each 
                  angle. TODO: check ELYRA and N-SIM</li>
                <li><b>Why?</b> accurate k0 and line-spacing values are 
                  necessary for a successful reconstruction - it is better
                  to use values that are correct for the system than to 
                  attempt to determine specific values from a poor sample 
                  (which will fail).</li>
              </ul>
            <h3><a id="CalibGrating">Calibrate Grating (TODO)</a></h3>
              <ul>
                <li><b>What?</b> an image of the grating used to generate the
                  illumination pattern stripes (V2 OMX).</li>
                <li><b>Why?</b> the grating may become dirty (which is bad),
                  meaning that it must be cleaned...</li>
              </ul>
              -->
        <hr>


        <!-- Section describing the pre-processing checks -->
        <h2><a id="PreProc">Pre-processing Checks</h2>
            <h3><a id="SIZprof">Raw data Intensity profile</a></h3>
              <ul><li><b>What?</b> average intensity for each plane
                  (in the order: phase, Z, angle, time) where each channel is 
                  assigned an arbitrary color: 1st channel = blue, 2nd = green, 
                  3rd = red.</li>
                <li><b>Why?</b> helps judge bleaching and whether all angles 
                  show a similar intensity (as they should).</li>
              </ul>
            <h3><a id="SIfourier">Raw data Fourier plots</a></h3> 
              <ul><li><b>What?</b> 2D Fourier Transforms of each image plane, 
                  split into separate hyperstacks according to angle. NB. 
                  results contain a "Z" dimension that is actually phase then 
                  Z; there are sliders for channels and time.</li>
                <li><b>Why?</b> where features are in focus and their 
                  intensities are modulated by the illumination pattern, 2D FFTs 
                  of each plane in the raw SI data should show 1st and hopefully 
                  2nd order spots along a line perpendicular to the angle of 
                  illumination pattern stripes. </li>
              </ul>
            <h3><a id="SIfloaties">Raw data Motion Check</a></h3> 
              <ul><li><b>What?</b> shows features that move/float in-between 
                  recording data for different angles. Each angle (assumes 3!) 
                  is assigned a color: Cyan, Magenta, or Yellow, meaning that 
                  if a feature is present in all angles it will appear 
                  C+M+Y=White, or will exhibit the color of a specific angle(s)
                  if not (the color scheme chosen here is intended to make the 
                  distinction between angles and channels clear).</li>
                <li><b>Why?</b> the reconstruction algorithm assumes that all
                  features are sampled at each angle, and features that move 
                  between phases or angles will result in artifacts.</li>
              </ul>
            <h3><a id="SIMCNR">Raw data Modulation Contrast</a></h3> 
                <ul><li><b>What?</b> the Modulation Contrast-to-Noise Ratio 
                      (MCNR) is a ratio of SI illumination pattern strength to 
                      noise strength - values less than 3 are inadequate 
                      (purple), values ~6 are adequate (red), values 
                      of ~12 are good (orange), values of ~18 are very good
                      (yellow) and values of ~24 or better are excellent 
                      (white). NB. the display range must not be changed from
                      0 to 24 for meaningful interpretation of the Look-Up 
                      Table. Also reports an average MCNR value for auto-
                      thresholded image features (triangle method), and
                      an estimate for the optimal Wiener filter parameter for
                      OMX data reconstruction.</li>
                    <li><b>Why?</b> if the illumination pattern at a given 
                      feature is overpowered by the noise, reconstruction will 
                      fail - any features observed in such regions cannot be 
                      trusted.</li> 
                    <li><b>Exactly what?</b> the actual calculation 
                      carried out is, for each voxel in the real 3D image: 
                      <ol><li> a variance stabilizing Anscombe transform is 
                            performed out so that noise follows an approximately
                            Gaussian rather than Poissonian distribution</li>
                          <li>all phases are lined up (in fact, a "Z window" 
                            of such phase series is assembled - e.g. for 
                            Z window = 1, 2Z+1=3 Z planes are considered, so for 
                            Z window = 1 and 5 phases we have 15 planes - this is 
                            to increase signal-to-noise to a similar extent to the 
                            "band filtering" performed during reconstruction) and 
                            Fourier transformed to create a power spectrum of
                            the various frequencies present.</li>
                          <li>the power of the frequency components corresponding
                            to the illumination pattern modulation are divided by
                            the average of the highest frequency component for 
                            the same Z plane (taken to be dominated by noise).
                            The position of the modulation frequency component
                            is given by: vector_length * order / phases</li>
                          <li>values of "MCNR" that are consistent with 
                            satisfactory versus unsatisfactory reconstructions 
                            were determined empirically, but are in reasonable 
                            agreement with the "Rose criterion" which 
                            states that a contrast-to-noise ratio of more than 
                            5 is required for reliable detection of a signal.
                          </li>
                      </ol>
                    </li>
                  </ul>
                  <!--
             <p><i>TODO? noise estimation, feature detection (MF &amp; Sobel for
              ROI): value +view option</i></p>
                  -->
        <hr>


        <!-- Section describing the post-reconstruction checks -->
        <h2><a id="PostRecon">Post-reconstruction Checks</a></h2>
            <h3><a id="SIRhist">SIR histogram</a></h3> 
              <ul><li><b>What?</b> linear/logarithmic histograms showing 
                    relative contribution of negative values to the 
                    SI-Reconstructed result for each channel. Ratio of
                    positive to negative values reported.</li>
                    <li><b>Why?</b> negative values indicatate reconstruction  
                    artifacts. Where the ratio of positive to negative values 
                    at the histogram extremes is less than 5-10, this indicates
                    a poor reconstruction.</li>
              </ul>
            <h3><a id="SIRzvar">SIR Z Variation</a></h3> 
            <ul><li><b>What?</b> plots the minimum, and the mean value in 
                    each slice; and summarizes the standard deviation of the 
                    minimum value normalized by the stack mode intensity.</li>
                <li><b>Why?</b> large variations in the minimum value 
                    relative to the average indicate refractive index mismatch
                    or poor illumination pattern Z focus.</li>
              </ul>
            <h3><a id="SIRfourier">SIR Fourier plot</a></h3> 
              <ul><li><b>What?</b> a 2D Fourier transform "target" plots showing 
                    resolution lines and color-coded with a LUT to make relative
                    proportion of different frequencies more obvious.</li>
                  <li><b>Why?</b> these plots help judge the average resolution 
                    in the sample volume, limited by noise. A gradual decay of 
                    frequencies from the center (lowest frequency) to the edge
                    (highest frequency and resolution) indicates real high 
                    resolution information; whereas a flat spectrum indicates 
                    only noise at the higher frequencies.
                    Reconstruction artifacts may also be apparent as spots in 
                    the spectrum. Note that this check has the caveat that it 
                    is an average for the volume, so if the ROI includes more 
                    background than signals of interest it will be less
                    meaningful.</li>
              </ul>
            <h3><a id="SIRquality">SIR Mod Contrast map</h3> 
              <ul><li><b>What?</b> RGB image displaying a combination of 
                    intensity information and modulation contrast calculated
                    from the raw data. Values 0-255 correspond to 0-Stack Max, 
                    and Modulation contrast (&lt;3 purple, to 6 red, to 12 
                    orange, to 18 yellow, to 24 white). Features that are 
                    red-orange, yellow or white (i.e. MCNR &gt;6) can be 
                    considered reliable. Note that ImageJ shows the R,G,B pixel
                    values in its status bar when you hover over a pixel with 
                    the pointer.</li>
                    <li><b>Why?</b> intended as a quantitative tool for 
                    assessing whether individual features in the reconstructed 
                    data are supported by the raw data.</li> 
              </ul>
        <hr>
                                                                                
                                                                                
        <!-- Section describing utilties for manipulating SIM data -->
        <h2><a id="SIUtils">SI Utilities</a></h2>
            <h3><a id="SItoWF">SI to wide-field</a></h3> 
              <ul><li><b>What?</b> generates a wide-field image by averaging 
                    phases (and optionally all angles). TODO: resample to same
                    size as reconstruction; investigate MRC export and/or 
                    deconvolution.</li>
                  <li><b>Why?</b> for comparison of wide-field and reconstructed
                    SI images, and to check for the presence of features
                    observed in the latter in the former.</li>
              </ul>
            <h3><a id="SIformats">SI format converter</a></h3> 
              <ul><li><b>What?</b> converts non-API OMX format SIM data into 
                    the OMX's "CPZAT" dimension ordering.</li>
                  <li><b>Why?</b> all of the Check plugins assume and 
                    require this dimension ordering to work correctly.</li>
              </ul>
        <hr>
                                                                                
                                                                                
        <!-- Link to auto-generated javadocs -->
        <h2><a href="http://microna.bioch.ox.ac.uk/~graemeb/api/index.html">API Docs</a></h2>
        <hr>
                                                                                
                                                                                
        <!-- footer with link to author & micron -->
        <center>The SIMcheck ImageJ plugin package was written by 
            <a href="http://www.micron.ox.ac.uk/microngroup/people/Graeme.shtml">Graeme Ball</a>.
        </center>

    </body>                                                                     

</html> 
